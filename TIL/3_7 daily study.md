# 결제 푸시 알림 메시지

### 카드사

- [ㅇㅇ카드] 결제승인 12,345원 일시불 01/23 12:34

- [ㅇㅇ카드] 결제승인 123,456원 할부(3개월) 01/23 12:34

### 은행

### 페이

- Samsung Pay : 가게이름 ￦12,345 결제 내역 확인

# 알림 긁어오기

- 알림 긁어오는 Service

| 비교 항목              | NotificationListenerService | AccessibilityService         |
| ------------------ | --------------------------- | ---------------------------- |
| **목적**             | 푸시 알림 감지                    | 화면 내 UI 요소 감지 및 조작           |
| **감지 대상**          | 알림(Notification)            | 버튼, 텍스트, 화면 UI 요소            |
| **백그라운드 실행**       | 가능                          | 가능하지만 배터리 소모 큼               |
| **필요한 권한**         | 알림 접근 권한                    | 접근성(Accessibility) 권한        |
| **루팅 필요 여부**       | ❌ 필요 없음                     | ❌ 필요 없음                      |
| **사용 예시**          | 메시지 알림 감지, 푸시 알림 저장         | 자동 클릭, 화면 내 UI 분석            |
| **보안 위험**          | 개인정보 유출 가능성 있음              | 높은 보안 위험, Google Play 등록 어려움 |
| **Google Play 심사** | 일부 제한 있음                    | 보안상 등록이 매우 어려움               |

- 크롤링과 AccessibilityService의 차이

| 비교 항목            | 크롤링 (Web Scraping) | AccessibilityService     |
| ---------------- | ------------------ | ------------------------ |
| **대상**           | 웹사이트 (HTML, API)   | 안드로이드 앱 화면 (UI 요소)       |
| **작동 방식**        | HTML 파싱, API 호출    | UI 이벤트 감지 및 자동화          |
| **접근 권한**        | 웹사이트 공개 데이터        | 접근성 권한 필요 (민감)           |
| **보안 제한**        | 일부 사이트에서 차단 가능     | 앱 보안 정책 위반 가능성 높음        |
| **자동화 수준**       | API 요청으로 데이터 추출 가능 | UI 조작을 통해 화면에서 직접 읽기     |
| **Google 정책 문제** | 웹사이트 정책에 따라 다름     | Google Play에서 차단될 가능성 높음 |

### AccessibilityService

- 안드로이드 접근성 서비스

- 크롤링과는 다르게 화면의 글자를 긁어오고 강제 조작도 가능하다.
  
  - 특정 앱 강제 실행 + 자동 클릭 조합으로 구매내역을 알아서 긁어오기 가능

- 보안 관련으로google play에서는 장애인을 도와주는 서비스만 사용 허가해줌

- 가져올 수 있는 정보
  
  - 화면 UI에 표시된 텍스트
  
  - 버튼, 입력 필드, 체크박스 등 UI 속성
  
  - UI 요소의 계층 구조 파악
  
  - 화면에 보이지 않는 UI 요소나 보안으로 ***처리된 비밀번호 등은 가져올 수 없음
  
  - OCR(문자 인식) 기능이 내장되어 있지 않음

- 플로우
  
  - 다른 앱 실행시키기 (`Intent` 활용)
  
  - 구매 내역 페이지 이동시키기 (`AccessibilityService`로 버튼 클릭)
  
  - 자동 스크롤하면서 구매 내역 추출 (`Gesture API` 활용)
  
  - 구매 내역 글자 추출 (`AccessibilityService`로 UI 내 텍스트 가져오기)

- **이론적으로 가능**하지만, 쿠팡 앱의 보안 정책이 강화되면 작동하지 않을 가능성이 높음.

- Google Play 스토어에서 **이 기능을 포함한 앱을 배포하면 정책 위반으로 거부될 가능성이 큼**.

- 공식 API가 없다면, **OCR을 이용한 스크린샷 분석** 같은 대안을 고려하는 것이 더 안전함.

# 애뮬레이터에서 문자 주고받기

- ~~Android Device Monitor 사용~~
  
  - [안드로이드 개발 에뮬레이터에 문자 발송하는 방법](https://mainia.tistory.com/5592)

- ~~여러 에뮬레이터 사용:~~
  
  - ~~두 개의 에뮬레이터를 동시에 실행합니다.~~
  - ~~각 에뮬레이터의 전화번호는 **`5554`**, **`5556`** 등으로 지정됩니다.~~
  - ~~한 에뮬레이터에서 다른 에뮬레이터로 SMS를 보낼 수 있습니다~~

- ~~텔넷(Telnet) 사용~~
  
  - ~~명령 프롬프트에서 **`telnet localhost 5554`** 명령어를 실행합니다 (5554는 에뮬레이터 포트 번호)[1](https://dev.to/nikola/how-to-simulate-an-incoming-call-or-sms-to-an-emulator-in-android-studio--3hfg)[3](https://stackoverflow.com/questions/3537307/simulating-sms-on-android-devices-when-developing).~~
  - ~~연결된 후 **`sms send <전화번호> "<메시지 내용>"`** 명령어로 SMS를 발송할 수 있습니다~~

- ~~ADB (Android Debug Bridge) 사용:~~
  
  - ~~터미널이나 명령 프롬프트에서 실행~~

```jsx
adb emu sms send <발신번호> <메시지>
```

- ~~에뮬레이터 확장 컨트롤 사용:~~
  - ~~에뮬레이터 오른쪽 도구 모음에서 "..." (더보기) 아이콘을 클릭합니다.~~
  - ~~확장된 컨트롤에서 "Phone" 탭을 선택합니다.~~
  - ~~메시지를 입력하고 "Send Message" 버튼을 클릭하여 SMS를 보낼 수 있습니다[2](https://google-developer-training.github.io/android-developer-phone-sms-course/Lesson%202/2_p_2_sending_sms_messages.html).~~

# Play Store에서 google Chat 다운로드 후 사용

- 구글 계정 2개로 주고받으면 편하다.

# 화면 캡처 - MediaProjection API

**화면 캡처 권한을 요청한 후**, 특정 버튼이나 동작을 하면 화면을 캡처하는 식으로 작동 가능

- 접근성 권한이 아니라 화면 녹화 권한이기 때문에 보안상 꽤괜
- 리액트 네이티브에서는 `react-native-media-projection` 라이브러리를 활용하면 쉽게 구현할 수 있다.

## 단점

- 스크롤 내리며 긴 화면 캡처는 불가

## 해결방안

### 1. 갤럭시의 경우 사용자에게 스마트캡처 방법 알려주고 유도

### 2. 우리가 스크롤 내리면서 캡처해주기

- 스크롤 내리는 데 AccessibilityService 필요 ⇒ 글자 다 긁어오기랑 같은 문제 발생

- 이미지 스티칭(Image Stitching) 사용
  
  - 여러 개의 이미지가 **겹치는 부분(Overlap)을 인식**하고, 이들을 **정렬(Alignment)한 후 하나의 이미지로 연결**
  - **ORB (Oriented FAST and Rotated BRIEF)**
    - **빠르고 가벼운 알고리즘**으로, 실시간 애플리케이션에 적합
    - 정확도는 SIFT/SURF보다 떨어짐
    - OpenCV에서 기본 제공됨
    - 파이썬 서버 따로 열어줘야 함

- 계산(연산)으로 빡구현1
  
  1. **스크롤 위치 계산:**
     - 스크롤 뷰의 현재 스크롤 위치를 가져옵니다.
     - 각 캡처 시점에 스크롤 위치를 기록합니다.
  2. **캡처 영역 계산:**
     - 각 캡처 시점에 캡처되는 영역의 높이를 계산합니다.
     - 캡처 영역의 높이는 스크롤 뷰의 보이는 영역의 높이와 같거나 약간 클 수 있습니다.
  3. **겹치는 부분 계산:**
     - 연속된 두 캡처 이미지 간의 스크롤 위치 차이를 계산합니다.
     - 이 차이가 캡처 영역의 높이보다 작으면 겹치는 부분이 발생합니다.
     - 겹치는 부분의 높이는 캡처 영역의 높이와 스크롤 위치 차이의 합으로 계산할 수 있습니다.
  4. **이미지 이어붙이기:**
     - 첫 번째 캡처 이미지를 결과 이미지에 그립니다.
     - 두 번째 캡처 이미지부터는 겹치는 부분을 제외하고 결과 이미지에 그립니다.
     - 이 과정을 모든 캡처 이미지에 대해 반복합니다.
  
  **주의 사항:**
  
  - **정확한 계산:**
    - 겹치는 부분을 정확하게 계산해야 이미지 이어붙이기 결과가 자연스럽습니다.
  - **성능:**
    - 이미지 이어붙이기 작업은 메모리 사용량이 많고 시간이 오래 걸릴 수 있으므로, 성능 최적화에 신경 써야 합니다.
  - **디바이스별 차이:**
    - 디바이스별로 스크롤 뷰의 동작 방식이 다를 수 있으므로, 다양한 디바이스에서 테스트해야 합니다.

- 계산(연산)으로 빡구현2
  
  - 스크롤 내리게 하는 높이를 지정하고 그만큼 제거하면서 합치기
  - 내려다가 AccessibilityService에서
  
  ```
  event.getScrollY()
  ```
  
  를 사용하여 현재 스크롤 위치 확인
  
  ```
  event.getMaxScrollY()
  ```
  
  를 비교하여 끝까지 갔는지 체크
  
  하고 높이 계산해서 합치기