# [TIL] 03-07

## 1. Android Notification Listener in React Native

- **목적**: 다른 앱(카카오페이, 네이버페이, 은행 등)에서 발생한 알림을 가져와 가계부 서비스에 활용하기 위해 Android의 `NotificationListenerService`를 React Native로 구현하는 방법을 학습.

- **iOS 지원 불가**: iOS는 시스템 정책상 NotificationListenerService와 같은 "타 앱 알림 가로채기" 기능을 제공하지 않으므로, 안드로이드에서만 가능.

### 직접 구현 vs 라이브러리 활용

1. **직접 구현**

   - 네이티브(Java/Kotlin)에서 `NotificationListenerService`를 상속받아 `onNotificationPosted` 메서드를 통해 알림 정보를 추출 후, React Native로 브리지(이벤트) 전달.
   - Manifest 설정, 권한 요청 로직, ReactContext 연동 등이 필요하여 구현 난이도가 다소 있음.

2. **라이브러리 사용**: [react-native-android-notification-listener](https://www.npmjs.com/package/react-native-android-notification-listener)

   - 내부적으로 `NotificationListenerService` + Headless JS 연동을 이미 처리해둔 라이브러리.
   - **장점**: 네이티브 코드 작성량이 줄어들며, 앱이 백그라운드/종료 상태에서도 알림을 자동 수신 가능.
   - **단점**: 여전히 iOS에서는 적용 불가.

---

## 2. `react-native-android-notification-listener` 사용 예시

```bash
# RN 0.68 이상 (예시)
yarn add react-native-android-notification-listener
```

### **index.js** (또는 App.js)

```js
import { AppRegistry } from 'react-native';
import RNAndroidNotificationListener, {
  RNAndroidNotificationListenerHeadlessJsName,
} from 'react-native-android-notification-listener';

// 권한 체크 & 요청
(async () => {
  const status = await RNAndroidNotificationListener.getPermissionStatus();
  if (status !== 'authorized') {
    await RNAndroidNotificationListener.requestPermission();
  }
})().catch(err => console.warn('Permission error:', err));

// 헤드리스 태스크
const headlessNotificationListener = async ({ notification }) => {
  if (!notification) return;
  try {
    const data = JSON.parse(notification);
    const targetPackages = ['com.kakaopay', 'com.nhn.android.search', 'com.mybank'];
    if (!targetPackages.includes(data.app)) return;

    const priceRegex = /\d{1,3}(,\d{3})*(원)?/g;
    const matched = data.text.match(priceRegex);
  } catch (error) {
    console.warn('Headless listener error:', error);
  }
};

AppRegistry.registerHeadlessTask(
  RNAndroidNotificationListenerHeadlessJsName,
  () => headlessNotificationListener
);

import App from './App';
AppRegistry.registerComponent('MyReactNativeApp', () => App);
```

### **App.js** (UI 예시)

```js
import React, { useState, useEffect } from 'react';
import { View, Text, Button } from 'react-native';
import RNAndroidNotificationListener from 'react-native-android-notification-listener';

const App = () => {
  const [permissionStatus, setPermissionStatus] = useState('unknown');

  useEffect(() => {
    (async () => {
      const status = await RNAndroidNotificationListener.getPermissionStatus();
      setPermissionStatus(status);
    })();
  }, []);

  const requestPermission = async () => {
    await RNAndroidNotificationListener.requestPermission();
    const status = await RNAndroidNotificationListener.getPermissionStatus();
    setPermissionStatus(status);
  };

  return (
    <View style={{ padding: 16 }}>
      <Text>Notification Access: {permissionStatus}</Text>
      {permissionStatus !== 'authorized' && (
        <Button title="권한 요청" onPress={requestPermission} />
      )}
    </View>
  );
};

export default App;
```

---

## 3. Android 시뮬레이터에서의 한계

- **다른 앱 알림 테스트의 어려움**: 에뮬레이터에는 카카오페이, 네이버페이 등 금융 앱이 기본 설치되지 않으며, 보안 이슈로 인증 자체가 불가능한 경우가 많음.
- **실기기 테스트 권장**: Notification Listener 권한과 실제 푸시 알림 플로우를 제대로 확인하려면 **실제 안드로이드 기기**에서 앱 설치 후 진행해야 함.

---

## 4. 정리

1. **Android 알림 접근**: `react-native-android-notification-listener`를 사용하면 백그라운드나 앱 종료 상태에서도 알림 데이터를 수집 가능.
2. **iOS 미지원**: iOS는 시스템 정책상 동일 기능 불가.
3. **금융 알림 파싱**: 특정 패키지명 필터링 후, 알림 텍스트에서 금액/시간 등 필요한 정보를 파싱하여 활용 가능. OpenAI API 활용 가능.
4. **실기기 테스트 필수**: 에뮬레이터는 금융 앱 알림 테스트에 비적합하므로, Android 실기기에서 권한 설정 + 알림 발생 과정을 검증해야 함.
