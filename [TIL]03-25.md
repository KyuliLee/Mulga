### 열심히 프롬프팅 진행중!

import os
from openai import OpenAI
from dotenv import load_dotenv
load_dotenv()

client = OpenAI(
    api_key=os.environ.get("OPENAI_API_KEY_MULGA"),
)

prompt = """
당신은 한국어 모바일 푸시 알림에서 금융 거래 정보를 추출해 MongoDB에 저장할 JSON 객체로 반환하는 전문가입니다. API 호출마다 하나의 푸시 알림 텍스트 전체를 입력받고, 반드시 하나의 JSON 객체만 반환합니다. 금융 거래가 아니면 `{}`를 반환하세요.

1️⃣ 필터링  
- 결제(“결제”, “결제되었습니다”), 취소(“취소”, “승인취소”), 환불(“환불”), 적립(“적립”)만 통과  
- 광고성(“혜택”, “이벤트”, “쿠폰”) 제외  

2️⃣ 추출 (값 없으면 null)  
• title: 상품명(수량 포함) — 판매처나 페이 서비스명이면 null  
• vendor: 판매처 이름  
• paymentMethod: 결제수단(카드사·은행·페이 서비스) 
• cost: 지출 내역이 있을 때) 결제인 경우: 값이 있으면 음수, 취소/환불: 양수(숫자만) / 없을 때 : 0
• time: ISO8601 (YYYY‑MM‑DDThh:mm:ssZ)  
• year, month, day  
• isCombined: false  
• category: 아래 한글 카테고리 → 영어 소문자 

4️⃣ 카테고리 매핑  
식비→food, 카페/간식→cafe, 주류/펍→liquor, 생활→living, 교통→traffic, 쇼핑→shopping, 뷰티/미용→beauty, 취미/여가→leisure, 여행/숙박→travel, 의료/건강→health, 이체→transfer, 주거/통신→home, 구독→subscription, 교육→education, 기타→etc

"""

def chat_with_gpt(user_prompt):
    try:
        # ChatGPT API 호출
        response = client.chat.completions.create(
            model="gpt-4o-mini",  # 모델명 지정
            temperature=0.0,
            messages=[
                {"role": "system", "content": prompt},
                {"role": "user", "content": user_prompt}
            ]
        )

        # 모델의 응답 추출
        reply = response.choices[0].message.content
        return reply

    except Exception as e:
        return f"Error: {str(e)}"


if __name__ == "__main__":
    # 사용자 입력 받기
    user_prompt ="""
    - **크라운 마이쮸 복숭아맛 44... 외 2개 상품이 결제되었습니다.**
    
    Bundle[{android.title=싸군과자몰, android.reduced.images=true, android.subText=null, android.template=android.app.Notification$BigTextStyle, android.showChronometer=false, android.text=크라운 마이쮸 복숭아맛 44... 외 2개 상품이 결제되었습니다., android.progress=0, androidx.core.app.extra.COMPAT_TEMPLATE=androidx.core.app.NotificationCompat$BigTextStyle, android.progressMax=0, android.appInfo=ApplicationInfo{d48c790 com.nhn.android.search}, android.showWhen=true, android.largeIcon=Icon(typ=BITMAP size=95x95), pushExtraKey=true, android.bigText=크라운 마이쮸 복숭아맛 44... 외 2개 상품이 결제되었습니다., android.infoText=null, android.progressIndeterminate=false, android.remoteInputHistory=null, android.summaryText=네이버 페이}] 2025-03-25 15:14:09.815
"""

    # API 호출 및 응답 출력
    response = chat_with_gpt(user_prompt)
    print("\nChatGPT Response:")
    print(response)
